---
import AstroLogoSpread from '@images/astro/astro-9.svg';
import AstroLogoBook from '@images/astro/astro-6.svg';
import AstroLogoGame from '@images/astro/astro-10.svg';
import AstroLogoPencil from '@images/astro/astro-8.svg';
import AstroLogoDesk from '@images/astro/astro-3.svg';

interface NavigationLinks {
  [key: string]: string;
}

const baseURL = import.meta.env.BASE_URL;
const pathname = Astro.url.pathname;

const obj: NavigationLinks = {
  home: `${baseURL}`,
  cookbook: `${baseURL}about/cookbook`,
  about: `${baseURL}about`,
  // blog: `${baseURL}blog`
};

let AstroLogo = AstroLogoSpread;
const customNavClasses =
  pathname.includes('about') && !pathname.includes('cookbook')
    ? 'border-b-2 border-light'
    : '';

if (pathname.includes('cookbook')) {
  AstroLogo = AstroLogoBook;
} else if (pathname.includes('about')) {
  AstroLogo = AstroLogoGame;
} else if (pathname.includes('blog')) {
  AstroLogo = AstroLogoPencil;
} else if (
  pathname.includes('style') ||
  pathname.includes('register') ||
  pathname.includes('sign-in')
) {
  AstroLogo = AstroLogoDesk;
}

if (pathname.includes('cookbook') && !pathname.includes('about')) {
  obj.cookbook = `${baseURL}cookbook`;
}

// If on homepage, don't include the 'href' attribute on the link element
const homepageLinkAttributes = pathname === baseURL ? {} : { href: baseURL };

const nonLinkClasses =
  'text-light/80 hover:text-light/80 dark:text-light/80 dark:hover:text-light/80 w-max px-3 py-2 uppercase text-sm';
const linkClasses =
  'text-light hover:text-green-emerald hover:scale-110 transition-[color,scale] w-max px-3 py-2 uppercase text-sm';

const navItems: string[] = Object.keys(obj).map(
  (key) =>
    `<li class='flex items-center'>
      ${pathname === obj[key] ? `<span class="${nonLinkClasses}">${key}</span>` : `<a href="${obj[key]}" class="${linkClasses}">${key}</a>`}
  </li>`,
);
---

<nav
  id="main-nav"
  class={`bg-blue-darkest/80 dark:bg-green-darker/80 text-light font-semibold tracking-wider rounded-none sticky top-0 tablet:pb-4 z-30 pt-4 pb-2 mx-auto w-full max-w-full backdrop-blur-md transition-[border-radius,top,margin,max-width,width] duration-700 ${customNavClasses}`}
>
  <div
    class="container flex flex-wrap items-center justify-around tablet:justify-between gap-y-2"
  >
    <a href="#main" class="skip-link">Skip to content</a>

    <div class="group flex items-center">
      <AstroLogo
        class={pathname === baseURL
          ? 'h-10 tablet:h-12 w-auto'
          : 'h-10 tablet:h-12 w-auto group-hover:-rotate-12 transition-transform'}
      />
      {
        pathname === baseURL ? (
          <span class="px-4 py-2">
            <span class="tablet:hidden">DP</span>
            <span class="hidden tablet:block">David’s Place</span>
          </span>
        ) : (
          <a
            {...homepageLinkAttributes}
            class="group-hover:text-green-emerald px-4 py-2 transition-[color,scale] group-hover:scale-110"
            aria-label="David’s Place Homepage"
          >
            <span class="tablet:hidden">DP</span>
            <span class="hidden tablet:block">David’s Place</span>
          </a>
        )
      }
    </div>

    <div class="flex items-center gap-4">
      <!-- Nav items visible on tablet+ -->
      <ul class="laptop:flex hidden items-center gap-3" set:html={navItems} />

      <fieldset class="flex flex-col items-center gap-1">
        <legend class="sr-only">Select Dark Mode:</legend>
        <input
          type="checkbox"
          id="darkModeSwitch"
          checked="true"
          class="bg-light before:bg-green-dark checked:bg-light checked:before:bg-blue-dark relative h-6 w-12 appearance-none rounded-full transition-all duration-500 before:absolute before:top-1/2 before:left-1 before:h-4 before:w-4 before:-translate-y-1/2 before:rounded-full before:transition-all before:duration-500 before:content-[''] checked:before:left-7 hover:brightness-125"
        />
        <label
          for="darkModeSwitch"
          class="w-[70px] text-center text-xs opacity-75">Dark Mode</label
        >
      </fieldset>

      <div class="flex items-center gap-2">
        <button
          id="font-decrease"
          class="border-light/10 hover:border-green-emerald active:border-light/10 flex min-h-5 min-w-10 items-center justify-center border-b px-1 py-1 duration-300"
          aria-label="Decrease Font Size">A-</button
        >
        <span
          ><span class="sr-only">Current font size:</span><span id="font-size"
            >16</span
          ></span
        >
        <button
          id="font-increase"
          class="border-light/10 hover:border-green-emerald active:border-light/10 flex min-h-5 min-w-10 items-center justify-center border-b-2 px-1 py-1 duration-300"
          aria-label="Increase Font Size">A+</button
        >
      </div>
    </div>
  </div>

  <!-- Nav items visible on mobile only -->
  <div
    id="mobile-nav"
    class="laptop:hidden container h-14 opacity-100 transition-[height,opacity] duration-500"
  >
    <span class="border-t-green-emerald my-4 block border-t"></span>
    <ul
      class="flex flex-wrap items-center justify-center gap-x-4 gap-y-2"
      set:html={navItems}
    />
  </div>
</nav>

<style>
  .skip-link {
    position: absolute;
    top: calc(var(--spacing) * 3);
    left: calc(1 / 2 * 100%);
    --tw-translate-x: calc(calc(1 / 2 * 100%) * -1);
    translate: var(--tw-translate-x) var(--tw-translate-y);
    --tw-translate-y: calc(175% * -1);
    translate: var(--tw-translate-x) var(--tw-translate-y);
    width: max-content;
    background-color: var(--color-dark);
    color: var(--color-light);
    padding-inline: calc(var(--spacing) * 5);
    height: calc(var(--spacing) * 10);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 40;
    border-radius: var(--radius-lg);
    font-family: var(--font-mono);
    text-transform: uppercase;
    font-size: var(--text-xs);
    line-height: var(--tw-leading, var(--text-xs--line-height));
    transition-property: all;
    transition-timing-function: var(
      --tw-ease,
      var(--default-transition-timing-function)
    );
    transition-duration: var(--tw-duration, var(--default-transition-duration));
    --tw-duration: 500ms;
    transition-duration: 500ms;
  }

  .skip-link:focus {
    --tw-translate-y: calc((1 / 6 * 100%) * -1);
    translate: var(--tw-translate-x) var(--tw-translate-y);
  }
</style>

<script is:inline>
  // Theme Management
  (function () {
    const darkModeSwitch = document.getElementById('darkModeSwitch');
    const darkModeLabel = document.querySelector('label[for="darkModeSwitch"]');
    const htmlElement = document.documentElement;
    const isDark =
      localStorage.theme === 'dark' ||
      (!('theme' in localStorage) &&
        window.matchMedia('(prefers-color-scheme: dark)').matches);

    // Apply theme
    if (isDark) {
      htmlElement.classList.add('dark');
      if (darkModeSwitch && darkModeLabel) {
        darkModeSwitch.checked = true;
        darkModeSwitch.setAttribute('aria-checked', 'true');
        darkModeLabel.textContent = 'Dark Mode';
      }
    } else {
      htmlElement.classList.remove('dark');
      if (darkModeSwitch && darkModeLabel) {
        darkModeSwitch.checked = false;
        darkModeSwitch.setAttribute('aria-checked', 'false');
        darkModeLabel.textContent = 'Light Mode';
      }
    }

    // Bind event listener
    if (darkModeSwitch) {
      darkModeSwitch.addEventListener('click', function (event) {
        const isChecked = event.target.checked;
        localStorage.theme = isChecked ? 'dark' : 'light';

        if (isChecked) {
          htmlElement.classList.add('dark');
          darkModeLabel.textContent = 'Dark Mode';
          darkModeSwitch.setAttribute('aria-checked', 'true');
        } else {
          htmlElement.classList.remove('dark');
          darkModeLabel.textContent = 'Light Mode';
          darkModeSwitch.setAttribute('aria-checked', 'false');
        }
      });
    }
  })();

  // Font Size Management
  (function () {
    const root = document.documentElement;
    const fontSizeElement = document.getElementById('font-size');
    const decreaseBtn = document.getElementById('font-decrease');
    const increaseBtn = document.getElementById('font-increase');

    // Cache the current font size to avoid reading from getComputedStyle
    let currentFontSize = 16; // Default font size

    function updateFontSizeDisplay() {
      // Check if there's a stored font size preference
      const storedFontSize = localStorage.fontSize;

      if (storedFontSize) {
        // Apply stored font size to root element and display
        currentFontSize = parseInt(storedFontSize, 10);
        root.style.fontSize = `${currentFontSize}px`;
        if (fontSizeElement) {
          fontSizeElement.textContent = currentFontSize;
        }
      } else {
        // No stored preference, read computed size and store it (only once on init)
        const computedSize = parseFloat(getComputedStyle(root).fontSize);
        currentFontSize = Math.round(computedSize);
        localStorage.fontSize = currentFontSize;
        if (fontSizeElement) {
          fontSizeElement.textContent = currentFontSize;
        }
      }
    }

    function setFontSize(newSize) {
      currentFontSize = newSize;
      root.style.fontSize = `${newSize}px`;
      localStorage.fontSize = newSize;
      if (fontSizeElement) {
        fontSizeElement.textContent = newSize;
      }
    }

    // Initialize display
    updateFontSizeDisplay();

    // Bind event listeners - now using cached value instead of getComputedStyle
    if (decreaseBtn) {
      decreaseBtn.addEventListener('click', function () {
        setFontSize(currentFontSize - 1);
      });
    }

    if (increaseBtn) {
      increaseBtn.addEventListener('click', function () {
        setFontSize(currentFontSize + 1);
      });
    }
  })();
</script>

<!-- Handle nav scroll effect -->
<script>
  import { rafThrottle } from '../utilities/rafThrottle';

  const nav = document.getElementById('main-nav');
  const mobileNav = document.getElementById('mobile-nav');

  if (!nav || !mobileNav) {
    console.warn('Main nav elements not found');
  } else {
    const handleScroll = () => {
      const navScrollActive = window.scrollY > 250;

      if (navScrollActive) {
        nav.classList.remove('rounded-none', 'top-0', 'w-full', 'max-w-full');
        nav.classList.add(
          'rounded-2xl',
          'tablet:rounded-[999px]',
          'top-4',
          'w-[98%]',
          'max-w-[var(--breakpoint-desktopxl)]',
        );
        mobileNav.classList.remove('h-14', 'opacity-100');
        mobileNav.classList.add('h-0', 'overflow-hidden', 'opacity-0');
      } else {
        nav.classList.remove(
          'rounded-2xl',
          'tablet:rounded-[999px]',
          'top-4',
          'w-[98%]',
          'max-w-[var(--breakpoint-desktopxl)]',
        );
        nav.classList.add('rounded-none', 'top-0', 'w-full', 'max-w-full');
        mobileNav.classList.remove('h-0', 'overflow-hidden', 'opacity-0');
        mobileNav.classList.add('h-14', 'opacity-100');
      }
    };

    const onScroll = rafThrottle(handleScroll);

    // Set initial state on load
    handleScroll();

    window.addEventListener('scroll', onScroll, { passive: true });
  }
</script>
